#!/bin/bash
#
# Git pre-commit hook with clang-format for Unreal Engine projects
# First run: format all tracked C++ files
# Subsequent runs: format only staged files

set -e

# --- Path to clang-format (можно просто "clang-format" если в PATH) ---
CLANG="clang-format"
if ! command -v "$CLANG" >/dev/null 2>&1; then
    echo "[pre-commit] clang-format not found. Install clang-format or add to PATH."
    exit 1
fi

# --- Marker file to detect first run ---
MARKER=".git/.clang-format-all-done"
COUNT=0

# --- First run: format all tracked C++ files ---
if [ ! -f "$MARKER" ]; then
    echo "[pre-commit] First run: formatting ALL tracked C++ files..."
    for file in $(git ls-files '*.h' '*.hpp' '*.hxx' '*.inl' '*.cpp' '*.cc' '*.cxx'); do
        if [ -f "$file" ]; then
            "$CLANG" -i --style=file "$file"
            git add "$file"
            COUNT=$((COUNT+1))
        fi
    done
    touch "$MARKER"
else
    # --- Subsequent runs: format only staged C++ files ---
    echo "[pre-commit] Formatting STAGED C++ files..."
    for file in $(git diff --cached --name-only --diff-filter=ACMR -- '*.h' '*.hpp' '*.hxx' '*.inl' '*.cpp' '*.cc' '*.cxx'); do
        if [ -f "$file" ]; then
            "$CLANG" -i --style=file "$file"
            git add "$file"
            COUNT=$((COUNT+1))
        fi
    done
fi

echo "[pre-commit] clang-format applied to $COUNT file(s)."
