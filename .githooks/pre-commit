#!/bin/bash

# ------------------------------------------------------------------
#    Git pre-commit hook with clang-format for Unreal Engine projects
#    First run: format all tracked C++ files
#    Subsequent runs: format only staged files
# ------------------------------------------------------------------


set -e

# --- Path to clang-format (just "clang-format" if in PATH) ---
CLANG="clang-format"
if ! command -v "$CLANG" >/dev/null 2>&1; then
    echo "::notice::[pre-commit] clang-format not found. Install clang-format or add to PATH."
    exit 1
fi

# ------------------------------------------------------------------
#    Check for files with spaces in their names.
#    If any are found, print the list and abort the commit.
# ------------------------------------------------------------------


while IFS= read -r file; do
    if [[ "$file" == *" "* ]]; then
        echo "::error::[pre-commit] File with space: $file"
        FOUND=1
    fi
done < <(git ls-files)

if [[ -n $FOUND ]]; then
    echo "::error::[pre-commit] Commit aborted. Please rename files without spaces."
    exit 1
fi

# ------------------------------------------------------------------
#    If we got here, than no issues have been detected,
#    so the script will proceed to further steps.
# ------------------------------------------------------------------


# --- Marker file to detect first run ---
MARKER=".githooks/.clang-format-all-done"
COUNT=0

# --- First run: format all tracked C++ files ---
if [ ! -f "$MARKER" ]; then
    echo "::notice::[pre-commit] First run: formatting ALL tracked C++ files..."
    for file in $(git ls-files '*.h' '*.hpp' '*.hxx' '*.inl' '*.cpp' '*.cc' '*.cxx'); do
        if [ -f "$file" ]; then
            "$CLANG" -i --style=file "$file"
            git add "$file"
            COUNT=$((COUNT+1))
        fi
    done
    touch "$MARKER"
else
    # --- Subsequent runs: format only staged C++ files ---
    echo "::notice::[pre-commit] Formatting STAGED C++ files..."
    for file in $(git diff --cached --name-only --diff-filter=ACMR -- '*.h' '*.hpp' '*.hxx' '*.inl' '*.cpp' '*.cc' '*.cxx'); do
        if [ -f "$file" ]; then
            "$CLANG" -i --style=file "$file"
            git add "$file"
            COUNT=$((COUNT+1))
        fi
    done
fi

echo "::notice::[pre-commit] clang-format applied to $COUNT file(s)."